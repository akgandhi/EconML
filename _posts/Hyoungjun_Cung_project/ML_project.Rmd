---
title: "Estimating demand for retail stores"
description: |
  A short description of the post.
author:
  - name: Hyoungjun Kang, Cung Hoang
    url: {}
date: 03-02-2021
output:
  distill::distill_article:
    self_contained: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Question of interest

First, We want to estimate demand for retail stores. What factors are most important for sales of retail stores? How is this different for different types of stores?

After estimating demands, we want to focus on predicting prosperity of business district. Does a business district will prosper or collapse? why? what factors are the most important to estimate long-term success of a business district? How can we predict the success of newly developed business district?

## Data

```{r pressure, echo=FALSE, fig.cap="example of a business district", out.width = '50%'}
knitr::include_graphics("C:/Users/Administrator/Desktop/2021 Spring/Nonpara and ML/bd_map.jpg") 

```

https://golmok.seoul.go.kr/fixedAreaAnalysis.do

This is retail sales data of business districts in Seoul. Each observation represents the total sales of a specific category in a specific commercial district on a quarterly basis. In the picture above, I picked 3 business district as examples. The area is 113,805, 140,820, 262,527 squared meters. We can see that thea area is quite small.


In estimates_sales_year files, there are sales, number of transactions, percentage and amount of sales on weekdays and weekends and each day of the week, percentage and amount of sales generated in each time slot(00-06, 06-11, 11-14, 14-17, 17-21, 21-24), percentage and amount of sales generated by men, women and age groups, and number of transaction classified according to the above creteria, and number of stores.

Also, for other datasets, there are related variables like worker population(by age groups and sex), worker population for hinterland, floating population by sex, age, day of the week, and time slot, average operating month of a district and operated month for closed stores, number of nearby apartment complex and apartments classified by squared meters and price groups, average income and expenditure by sectors for hinterland dwellers.  


# import the data
```{r data,echo=FALSE}
# echo = FALSE : not show the data

# web version. takes too long, so I will work locally and update.
if (FALSE){
  estimated_sales_2020 <- read.csv("https://www.dropbox.com/s/1zcve0st9loa6vb/Businessdistrict_stores_2020.csv?dl=1")
  
  Businessdistrict_apartment <- read.csv("https://www.dropbox.com/s/yo7taotcc7dzbvv/Businessdistrict_apartment.csv?dl=1")
  
  
  Businessdistrict_changeindex <- read.csv("https://www.dropbox.com/s/ztq6h08zrd9n8f6/Businessdistrict_changeindex.csv?dl=1")
  
  
  Businessdistrict_estimated_floatingpopulation <- read.csv("https://www.dropbox.com/s/c1k9udgqdi06aik/Businessdistrict_estimated_floatingpopulation.csv?dl=1")
  
  
  Businessdistrict_stores_2020 <- read.csv("https://www.dropbox.com/s/kojdoy7v45h112a/Businessdistrict_stores_2020.csv?dl=1")
  
  Businessdistrict_worker_population <- read.csv("https://www.dropbox.com/s/oxu1tcyjf75ebuf/Businessdistrict_worker_population.csv?dl=1")
  
  
  Hinterland_income_consumption <- read.csv("https://www.dropbox.com/s/nb11gcgux9dszrm/Hinterland_income_consumption.csv?dl=1")
  
  
  Hinterland_worker_population <- read.csv("https://www.dropbox.com/s/rr1qzz7ehxhw007/Hinterland_worker_population.csv?dl=1")
}


 # codes for local work.
estimated_sales_2020 <- read.csv("C:/Users/Administrator/Desktop/2021 Spring/Nonpara and ML/estimated_sales_2020.csv")

Businessdistrict_apartment <- read.csv("C:/Users/Administrator/Desktop/2021 Spring/Nonpara and ML/Businessdistrict_apartment.csv")

Businessdistrict_changeindex <- read.csv("C:/Users/Administrator/Desktop/2021 Spring/Nonpara and ML/Businessdistrict_changeindex.csv")

Businessdistrict_estimated_floatingpopulation <- read.csv("C:/Users/Administrator/Desktop/2021 Spring/Nonpara and ML/Businessdistrict_estimated_floatingpopulation.csv")

Businessdistrict_stores_2020 <- read.csv("C:/Users/Administrator/Desktop/2021 Spring/Nonpara and ML/Businessdistrict_stores_2020.csv")

Businessdistrict_worker_population <- read.csv("C:/Users/Administrator/Desktop/2021 Spring/Nonpara and ML/Businessdistrict_worker_population.csv")

Hinterland_income_consumption <- read.csv("C:/Users/Administrator/Desktop/2021 Spring/Nonpara and ML/Hinterland_income_consumption.csv")

Hinterland_worker_population <- read.csv("C:/Users/Administrator/Desktop/2021 Spring/Nonpara and ML/Hinterland_worker_population.csv")

# rename columns
colnames(estimated_sales_2020) <- c("year", "quarter","bd_class_code","bd_class_codename","district_code","district_name",
                 "category_code","category_name","sales","number_of_transactions","sales_weekday_ratio","sales_weekend_ratio",
                 "sales_monday_ratio","sales_tuesday_ratio","sales_wednesday_ratio","sales_thursday_ratio","sales_friday_ratio","sales_saturday_ratio","sales_sunday_ratio",
                 "time_00.06_sales_ratio","time_06.11_sales_ratio","time_11.14_sales_ratio","time_14.17_sales_ratio","time_17.21_sales_ratio","time_21.24_sales_ratio",
                 "male_sales_ratio","female_sales_ratio","age10_sales_ratio","age20_sales_ratio","age30_sales_ratio","age40_sales_ratio","age50_sales_ratio","ageover60_sales_ratio",
                 "weekday_sales_amount","weekend_sales_amount","monday_sales_amount","tuesday_sales_amount","wednesday_sales_amount","thursday_sales_amount","friday_sales_amount","saturday_sales_amount","sunday_sales_amount",
                 "time_00.06_sales_amount","time_06.11_sales_amount","time_11.14_sales_amount","time_14.17_sales_amount","time_17.21_sales_amount","time_21.24_sales_amount",
                 "male_sales_amount","female_sales_amount","age10_sales_amount","age20_sales_amount","age30_sales_amount","age40_sales_amount","age50_sales_amount","ageover60_sales_amount",
                 "transaction_number_weekday","transaction_number_weekend","transaction_number_monday","transaction_number_tuesday","transaction_number_wednesday","transaction_number_thursday","transaction_number_friday","transaction_number_saturday","transaction_number_sunday",
                 "time_00.06_transaction","time_06.11_transaction","time_11.14_transaction","time_14.17_transaction","time_17.21_transaction","time_21.24_transaction",
                 "male_transaction","female_transaction","age10_transaction","age20_transaction","age30_transaction","age40_transaction","age50_transaction","ageover60_transaction",
                 "number_of_stores")

colnames(Businessdistrict_apartment) <- c("year", "quarter","bd_class_code","bd_class_codename","district_code","district_name",
                                          "apart_complex_number","apart_under66sqm","apart_66sqm","apart_99sqm","apart_132sqm","apart_165sqm",
                                          "apart_underprice1","apart_price1","apart_price2","apart_price3","apart_price4","apart_price5","apart_price6over",
                                          "apart_avg_area","apart_avg_price")

colnames(Businessdistrict_changeindex) <- c("year", "quarter","bd_class_code","bd_class_codename","district_code","district_name",
                                            "bd_change_index","bd_change_name","avg_operating_month","avg_operating_month_for_closed","avg_opmonth_of_seoul","avg_opmonth_ofseoul_for_closed"
                                            )

# For floating population file, I need more time to figure out what the time slot means.
#colnames(Businessdistrict_estimated_floatingpopulation) <- c()

colnames(Businessdistrict_stores_2020) <- c("year", "quarter","bd_class_code","bd_class_codename","district_code","district_name",
                                            "business_category_code","business_category_name","number_of_stores","number_of_stores_similar","open_rate","open_store_number","closing_rate","closed_store_number","franchise_store_number")

colnames(Businessdistrict_worker_population) <- c("year", "quarter","bd_class_code","bd_class_codename","district_code","district_name",
                                                  "total_worker_population","male_worker_population","female_worker_population",
                                                  "age10_worker_population","age20_worker_population","age30_worker_population","age40_worker_population","age50_worker_population","age60over_worker_population",
                                                  "male10_worker_population","male20_worker_population","male30_worker_population","male40_worker_population","male50_worker_population","male60over_worker_population",
                                                  "female10_worker_population","female20_worker_population","female30_worker_population","female40_worker_population","female50_worker_population","female60over_worker_population")

colnames(Hinterland_income_consumption) <- c("year", "quarter","bd_class_code","bd_class_codename","district_code","district_name",
                                                  "avg_monthly_income","income_segment","total_expenditure","grocery_expenditure","clothing_expenditure","household_goods_expenditure",
                                                  "medical_expenditure","transportation_expenditure","leisure_expenditure","culture_expenditure","education_expenditure","pleasure_expenditure")

colnames(Hinterland_worker_population) <- c("year", "quarter","bd_class_code","bd_class_codename","district_code","district_name",
                                            "total_worker_population","male_worker_population","female_worker_population",
                                            "age10_worker_population","age20_worker_population","age30_worker_population","age40_worker_population","age50_worker_population","age60over_worker_population",
                                            "male10_worker_population","male20_worker_population","male30_worker_population","male40_worker_population","male50_worker_population","male60over_worker_population",
                                            "female10_worker_population","female20_worker_population","female30_worker_population","female40_worker_population","female50_worker_population","female60over_worker_population")
 
merge_test <- merge(estimated_sales_2020,Businessdistrict_apartment,by=c("year","quarter","bd_class_code","bd_class_codename","district_code","district_name"))
merge_test <- merge(merge_test,Businessdistrict_changeindex,by=c("year","quarter","bd_class_code","bd_class_codename","district_code","district_name"))
merge_test <- merge(merge_test,Businessdistrict_worker_population,by=c("year","quarter","bd_class_code","bd_class_codename","district_code","district_name"))
merge_test <- merge(merge_test,Hinterland_income_consumption,by=c("year","quarter","bd_class_code","bd_class_codename","district_code","district_name"))
merge_test <- merge(merge_test,Hinterland_worker_population,by=c("year","quarter","bd_class_code","bd_class_codename","district_code","district_name"))
```

```{r summary_data,echo=FALSE}

summary(estimated_sales_2020)


```

## Including Plots

```{r plot_for_data}
library(dplyr)

# number of stores in one business district.
summary_data <- estimated_sales_2020 %>%
  group_by(year,quarter,district_code) %>% 
  summarise(sum = sum(number_of_stores),
            n = n())

summary_data

hist(summary_data$sum,breaks=1000,xlim =c(0,2000))
```

As we can see, \textbf{the business district usually consists of 0~100 stores}. As we have seen in the picture, the area is quite small. 

```{r plot_for_data2}
# number of stores in one business district, by category
summary_data2 <- estimated_sales_2020 %>%
  group_by(year,quarter,district_code,category_code) %>% 
  summarise(sum = sum(number_of_stores),
            n = n())
summary_data2
hist(summary_data2$sum,breaks=20000,xlim =c(0,100))
```

This is a plot for number of stores in a certain category in one business district.

```{r plot_for_data3}

# making histogram for each category.
diamonds %>%
  ggplot(aes(x = cut, y = carat)) +
  stat_summary_bin(fun.y = 'mean', geom = 'bar')
```

```{r tree}
library(rsample)
library(dplyr)
library(rpart)
library(rpart.plot)

set.seed(123)
ames_split <- initial_split(merge_test, prop = .7)
ames_train <- training(ames_split)
ames_test  <- testing(ames_split)

# grid for tuning parameters
hyper_grid <- expand.grid(
  minsplit = seq(5,20,1),
  maxdepth = seq(8,15,1)
)

head(hyper_grid)

models <- list()

for (i in 1:nrow(hyper_grid)) {
  
  # get minsplit, maxdepth values at row i
  minsplit <- hyper_grid$minsplit[i]
  maxdepth <- hyper_grid$maxdepth[i]
  
  # train a model and store in the list
  # print("minsplit, maxdepth is")
  # print(minsplit)
  # print(maxdepth)
  models[[i]] <- rpart(
    formula = sales ~ .,
    data    = ames_train,
    method  = "anova",
    control = list(minsplit = minsplit, maxdepth = maxdepth)
  )
}

# function to get optimal cp
get_cp <- function(x) {
  min    <- which.min(x$cptable[, "xerror"])
  cp <- x$cptable[min, "CP"] 
}

# function to get minimum error
get_min_error <- function(x) {
  min    <- which.min(x$cptable[, "xerror"])
  xerror <- x$cptable[min, "xerror"] 
}

hyper_grid %>%
  mutate(
    cp    = purrr::map_dbl(models, get_cp),
    error = purrr::map_dbl(models, get_min_error)
  ) %>%
  arrange(error) %>%
  top_n(-5, wt = error)

optimal_tree <- rpart(
  formula = sales ~ .,
  data    = ames_train,
  method  = "anova",
  control = list(minsplit = 10, maxdepth = 8, cp = 0.01)
)

pred <- predict(optimal_tree, newdata = ames_test)
p_error <- Metrics::rmse(actual = ames_test$sales, predicted = pred)
p_error


rpart.plot(optimal_tree,cex=0.5)

```

The above plot is a result for tree method. It doesn't seem to have predictive power. I think I have to estimate demands for each category. 

## Things to proceed

RF method

1) vary the hyperparameters and RMSE
2) list the most important variables based on impurity or permutation based importance

we have to do with t-1 data for sales_ratio or sales_amount.


